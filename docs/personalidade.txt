Esta √© a **Documenta√ß√£o T√©cnica Completa do Motor Psicol√≥gico e Narrativo (The Soul Engine)** de *Heroes of Majesty - Console Edition*.

Este documento unifica todas as decis√µes de design sobre comportamento, IA, c√°lculos matem√°ticos e gera√ß√£o de narrativa. Ele serve como o manual de engenharia para implementar a "vida" do jogo no Backend (Deno) e a visualiza√ß√£o no Frontend (Angular).

---

# üìò THE SOUL ENGINE: DOCUMENTA√á√ÉO MESTRA

**Vers√£o:** 3.0 (Behavioral & Interaction Systems)
**Escopo:** IA de Her√≥is, IA de Monstros, Personalidade do Conselheiro, Redes Sociais e Gera√ß√£o de Logs.

---

# PARTE I: O MOTOR DE HER√ìIS (SISTEMA P.E.R.M.A.)

Para garantir que cada her√≥i pare√ßa uma pessoa √∫nica e n√£o um rob√¥, abandonamos booleanos (`isBrave = true`) e adotamos **Vetores de Ponto Flutuante (0.0 a 1.0)**.

### 1.1. Os 5 Vetores Base

Estes valores s√£o gerados na cria√ß√£o do her√≥i (Seed) e raramente mudam permanentemente, definindo sua "Ess√™ncia".

| Vetor | Nome | 0.0 (Baixo) | 1.0 (Alto) | Impacto no Gameplay |
| --- | --- | --- | --- | --- |
| **P** | **Power (Aud√°cia)** | **Covarde:** Foge com 80% HP. Evita Elites. | **Temer√°rio:** Luta at√© 0% HP. Ataca Boss sozinho. | Define o `FleeThreshold` e o peso do risco no c√°lculo de IA. |
| **E** | **Ethics (√âtica)** | **Oportunista:** Rouba Kills (KS), ignora curar aliados. | **Paladino:** Cura aliados, divide loot, obedece ordens. | Define intera√ß√£o social e obedi√™ncia ao jogador. |
| **R** | **Resource (Gan√¢ncia)** | **Altru√≠sta:** Ignora ouro no ch√£o durante combate. | **Kleptoman√≠aco:** Para de lutar para pegar loot. | Define prioridade de `LOOT` vs `COMBAT`. |
| **M** | **Mind (Intelecto)** | **Instintivo:** Ataca o alvo mais pr√≥ximo. | **T√°tico:** Foca Healers/Magos, usa itens eficientemente. | Define sele√ß√£o de alvo e uso de invent√°rio. |
| **A** | **Affect (Humor)** | **Inst√°vel:** Humor vol√°til, quebra f√°cil sob press√£o. | **Estoico:** Mant√©m a calma, ignora insultos. | Define a volatilidade dos outros vetores sob estresse. |

---

### 1.2. Camadas de Modifica√ß√£o (O Contexto)

O comportamento final n√£o √© apenas o vetor base. Ele √© o resultado de uma soma de camadas.

**F√≥rmula Mestra de Comportamento:**
`Vetor_Efetivo = Clamp((Vetor_Base + Estado_Tempor√°rio + Mem√≥ria_Relacional) * Fator_Estresse, 0.0, 1.0)`

#### **A. Estados Tempor√°rios (Status Effects)**

Condi√ß√µes passageiras que alteram a personalidade.

| Estado | Gatilho | Modificadores Matem√°ticos | Descri√ß√£o L√≥gica |
| --- | --- | --- | --- |
| **B√äBADO** | Evento: Taverna | `P +0.3`, `M -0.4`, `E -0.2` | Fica corajoso e burro. Pode bater em amigos. |
| **FAMINTO** | Timer: Sem comida | `R +0.4`, `E -0.3` | Fica ganancioso e ego√≠sta. |
| **INSPIRADO** | Evento: Carta Real | `P +0.2`, `E +0.2` | B√¥nus tempor√°rio ap√≥s intera√ß√£o positiva. |
| **AMEDRONTADO** | Evento: Escurid√£o | `P -0.3` (Se n√£o tiver tocha) | Penalidade por falta de luz. |

#### **B. Peculiaridades (Quirks & Overrides)**

S√£o "Cartas Coringa" bin√°rias que, se ativadas, **ignoram a matem√°tica** e for√ßam uma a√ß√£o.

* `ARACHNOPHOBIA`: Se `Target == SPIDER` -> `Aud√°cia = 0.0` (Fuga Imediata).
* `GAMBLER`: Se `Location == TAVERN` -> Gasta 100% do Ouro.
* `HATE_UNDEAD`: Se `Target == ZOMBIE` -> `Aud√°cia = 1.0` (F√∫ria incontrol√°vel).

---

# PARTE II: O MOTOR DE MONSTROS (SISTEMA P.A.I.N.)

Monstros precisam ser previs√≠veis o suficiente para serem combatidos, mas vivos o suficiente para surpreender.

### 2.1. Os 4 Vetores Bestiais

| Vetor | Nome | 0.0 (Baixo) | 1.0 (Alto) | Comportamento |
| --- | --- | --- | --- | --- |
| **P** | **Preservation** | **Berserker:** Nunca foge. (Zumbis) | **Covarde:** Foge se ferido. (Goblins) |  |
| **A** | **Aggression** | **Passivo:** S√≥ contra-ataca. (Ents) | **Predador:** Persegue por todo o mapa. (Lobos) |  |
| **I** | **Intellect** | **Bestial:** Ataca o mais pr√≥ximo. | **Maligno:** Usa skills, foca o mais fraco. |  |
| **N** | **Nature** | **Solit√°rio:** Luta sozinho. (Ursos) | **Enxame:** Ganha buff se tiver aliados. (Ratos) |  |

### 2.2. Sistema de N√™mesis (Evolu√ß√£o)

Se um monstro matar um her√≥i (Last Hit), ele executa a rotina `promoteToNemesis()`:

1. **Ganho de Nome:** "Goblin" -> "Grak, o Matador de Kaelen".
2. **Buff de Stats:** HP +50%, Dano +20%.
3. **Mem√≥ria de √ìdio:** Ganha um vetor `Target_Priority` alto contra os *amigos* do her√≥i morto.
4. **Banter:** Passa a ter linhas de di√°logo provocativas no log.

---

# PARTE III: O CONSELHEIRO (O FILTRO DE VI√âS)

O Conselheiro (P7) √© um NPC com **Vieses Cognitivos**. Ele n√£o reporta a realidade crua; ele reporta a interpreta√ß√£o dele.

### 3.1. Arqu√©tipos (Sorteado no In√≠cio do Jogo)

| Arqu√©tipo | Vi√©s Principal | Fator de Risco | Estilo de Comunica√ß√£o |
| --- | --- | --- | --- |
| **O BAJULADOR** | `Medo` | Esconde falhas, exagera vit√≥rias. | "Uma retirada estrat√©gica brilhante, senhor!" (Sobre uma fuga covarde). |
| **O C√âTICO** | `Pessimismo` | Desencoraja explora√ß√£o. | "Vamos todos morrer naquela caverna. Recomendo ficar na vila." |
| **O BUROCRATA** | `Avareza` | Foca 100% em economizar ouro. | "Aquele her√≥i est√° gastando muitas po√ß√µes. Corte o suprimento." |
| **O FAN√ÅTICO** | `Agress√£o` | Incentiva morte e gl√≥ria. | "Sangue! Mais sangue! Mande eles atacarem o Drag√£o agora!" |

### 3.2. Din√¢mica de Humor

O humor do Conselheiro afeta a **precis√£o** das informa√ß√µes.

* **Reino Rico/Est√°vel:** Conselheiro calmo. Dicas precisas.
* **Reino em Crise:** Conselheiro estressado. Dicas err√°ticas, uso de CAPS LOCK, interrup√ß√µes frequentes.

---

# PARTE IV: MATEM√ÅTICA DE DECIS√ÉO (UTILITY AI)

Este √© o algoritmo que roda a cada tick no Backend para decidir o que o her√≥i faz.

### 4.1. C√°lculo de Score (Pontua√ß√£o de A√ß√£o)

Para cada entidade, o sistema avalia a√ß√µes poss√≠veis e atribui uma nota (Score). A maior nota vence.

**F√≥rmula Geral:**
`Score = (Recompensa_Base * Multiplicador_Personalidade) - (Risco / Aud√°cia)`

#### **Exemplo Pr√°tico: Her√≥i diante de um Ba√∫ com um Guarda**

* **Her√≥i:** Gan√¢ncia 0.9, Aud√°cia 0.2 (Ladr√£o Covarde).
* **A√ß√£o A: Lutar com Guarda**
* Recompensa Base (XP/Gl√≥ria): 50
* Mult. Personalidade (Aud√°cia 0.2): `50 * 0.2 = 10`
* Risco (Dano estimado): 40
* *Score Final:* `10 - (40 / 0.2)` = **-190** (P√¢nico Total).


* **A√ß√£o B: Tentar Roubar e Correr**
* Recompensa Base (Ouro): 100
* Mult. Personalidade (Gan√¢ncia 0.9): `100 * 0.9 = 90`
* Risco (Chance de falha): 20
* *Score Final:* `90 - (20 / 0.2)` = **-10** (Ainda medroso demais).


* **A√ß√£o C: Fugir**
* Recompensa Base (Sobreviv√™ncia): 100 (se Risco > 0)
* *Score Final:* **100**.



**Decis√£o:** O her√≥i foge.

---

# PARTE V: DIN√ÇMICA SOCIAL E DI√ÅLOGO

### 5.1. Matriz de Relacionamento

Cada par de her√≥is tem um `Affinity Score` (-100 a +100).

| Evento | Impacto na Afinidade | Condi√ß√£o |
| --- | --- | --- |
| **Salvar Vida (Cura/Tank)** | +10 a +30 | Se o alvo estava com HP < 30%. |
| **Compartilhar Loot** | +5 | Se √âtica do receptor > 0.5. |
| **Kill Steal (KS)** | -20 a -50 | Se Gan√¢ncia da v√≠tima > 0.6. |
| **Fogo Amigo (Dano)** | -10 | Acidental. |
| **Trai√ß√£o (PvP)** | -100 (N√™mesis) | Ataque direto intencional. |

### 5.2. O Sistema de "Banter" (Conversa)

O texto do di√°logo √© montado via **Slots Din√¢micos**.

**Estrutura do JSON de Di√°logo:**

```json
{
  "trigger": "KS_EVENT",
  "speaker_trait": "ARROGANT",
  "relationship": "RIVAL",
  "templates": [
    "Olhe e aprenda, {target}. √â assim que se mata.",
    "Lento demais. O ouro √© meu.",
    "Talvez na pr√≥xima vida voc√™ seja mais r√°pido, {target_class}."
  ]
}

```

**Algoritmo de Sele√ß√£o:**

1. Detectar Evento (KS).
2. Identificar Tra√ßo Dominante do Falante (Se Gan√¢ncia > outros, usa tag `GREEDY`).
3. Identificar Status de Rela√ß√£o (Se Afinidade < -20, usa tag `RIVAL`).
4. Sortear template compat√≠vel.

---

# PARTE VI: VISUALIZA√á√ÉO E UX (O QUE O JOGADOR V√ä)

O jogador n√£o v√™ os n√∫meros. Ele v√™ **Conceitos**.

### 6.1. Tradu√ß√£o de Dados (Backend -> Frontend)

O servi√ßo `NarrativeTranslator` converte os floats em Strings para a UI.

| Valor P.E.R.M.A. | String Exibida (F3 Library) |
| --- | --- |
| Aud√°cia 0.0 - 0.2 | "Covarde" |
| Aud√°cia 0.3 - 0.6 | "Cauteloso" |
| Aud√°cia 0.7 - 0.9 | "Bravio" |
| Aud√°cia 0.95+ | "Suicida / Temer√°rio" |

### 6.2. Cards de Insight (Timeline P5)

Quando uma decis√£o cr√≠tica √© tomada baseada em personalidade, o log se expande.

**Visual no Log:**

```text
[14:02] üèÉ KAELEN FUGIU DO COMBATE!
+--------------------------------------------------+
| üß† INSIGHT: P√ÇNICO                               |
| O her√≥i entrou em colapso mental.                |
| > Gatilho: Inimigo ARANHA (Fobia)                |
| > Estado: Isolado na Escurid√£o                   |
+--------------------------------------------------+

```

### 6.3. Visualiza√ß√£o de Rede (Aviary F5)

Um gr√°fico de n√≥s onde:

* **Dist√¢ncia:** Inversamente proporcional √† Afinidade (Perto = Amigo, Longe = Rival).
* **Cor da Linha:** Verde (Alian√ßa), Vermelha (Rivalidade), Cinza (Neutro).
* **Hover:** Exibe o "Motivo Principal" da rela√ß√£o (ex: "Unidos pela Batalha do Drag√£o").

---

# PARTE VII: INTEGRA√á√ÉO T√âCNICA (RESUMO)

1. **Deno (Backend):**
* Mant√©m o estado `GameState` com todos os vetores.
* Roda o loop `UtilityAI` a 4Hz.
* Processa `RelationshipUpdates` ap√≥s cada evento de combate.
* Envia `LogEvents` enriquecidos com metadados para o Frontend.


2. **Angular (Frontend):**
* Recebe JSON via WebSocket.
* `LogComponent`: Renderiza o texto e, se houver metadados de `Insight`, renderiza o Card abaixo.
* `LibraryComponent`: Traduz os n√∫meros recebidos em Strings (Covarde, Leal) para exibi√ß√£o.
* `AviaryComponent`: Renderiza o grafo de rela√ß√µes usando SVG ou Canvas simples.


3. **LLM (Integra√ß√£o Externa):**
* Usada APENAS para: Cartas (F5), Di√°logos de Acampamento (Flavor) e Resumo de Cr√¥nicas.
* N√£o usada para: Combate em tempo real (muito lento).



---

Esta documenta√ß√£o cobre todas as nuances necess√°rias para criar um sistema emergente, profundo e infinitamente replayable, onde a matem√°tica invis√≠vel gera hist√≥rias vis√≠veis.